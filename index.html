<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>20 Cycle Check ‚Äî Process Observation</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f7f7f9; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb;
    --radius:10px; --tap:40px; --fs:clamp(13px,2.2vw,15px); --fs-sm:clamp(11px,1.9vw,13px);
    --blue:#2563eb; --blue-600:#2563eb; --blue-500:#3b82f6; --blue-400:#60a5fa; --blue-300:#93c5fd;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;font-size:var(--fs);background:var(--bg);color:var(--ink)}
  .app{min-height:100%;padding:8px}

  /* Menyrad (kompakt, wrappar vid behov) */
  .menubar{
    display:flex;flex-wrap:wrap;align-items:center;gap:8px;
    background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);
    padding:6px 10px;margin-bottom:8px
  }
  .logo{font-weight:800;font-size:16px;white-space:nowrap;margin-right:auto}
  .menu-actions{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .langbar{display:flex;gap:6px;align-items:center}
  .flagbtn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm);cursor:pointer}
  .flagbtn.active{background:#eef2ff;border-color:#c7d2fe}
  .flag{font-size:16px;line-height:1}

  /* Layout */
  .row-top{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end}
  .process-grid{display:grid;grid-template-columns:1fr 160px;gap:8px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius)}
  .pad{padding:8px}
  .toolbar{display:flex;gap:6px;flex-wrap:wrap}
  label{font-size:var(--fs-sm);color:var(--muted)}
  input[type=text]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:var(--tap);padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;color:inherit;cursor:pointer}
  .btn.primary{background:var(--blue);color:#fff;border-color:#1d4ed8}
  .btn.secondary{background:#fff;border-color:var(--line)}
  .btn.danger{background:#fee2e2;border-color:#fecaca}
  .btn.small{min-height:34px;padding:6px 10px;font-size:var(--fs-sm)}
  .status{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);font-size:var(--fs-sm)}
  .timer{font-weight:800;font-size:16px;background:#0a0;color:#fff;padding:6px 10px;border-radius:8px;text-align:center;white-space:nowrap}

  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:8px;margin-top:8px}
  .chart-wrap{padding:6px}
  canvas{width:100%;height:360px;display:block}

  /* Lista ‚Äì tydligare rader */
  .list-head,.list-row{display:grid;grid-template-columns:56px 110px 1fr 40px;gap:8px;align-items:center}
  .list-head{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px;font-weight:700;z-index:1}
  .list{max-height:460px;overflow:auto;border-top:1px solid var(--line);padding:8px}
  .list-row{
    padding:10px; background:#fff; border:1px solid var(--line); border-radius:10px;
    margin-bottom:8px; box-shadow:0 1px 2px rgba(0,0,0,.04);
  }
  .list-row:nth-child(odd){background:#f9fbff}
  .list-row.selected{outline:2px solid #93c5fd;background:#eff6ff}
  .badge{display:inline-block;background:#e2e8f0;color:#334155;padding:4px 8px;border-radius:999px;font-size:var(--fs-sm);font-weight:600}
  textarea{width:100%;min-height:40px;border:1px solid var(--line);border-radius:8px;padding:6px;font:inherit;font-size:var(--fs-sm)}
  .delete-btn{cursor:pointer;border:none;background:none;font-size:18px;line-height:1;color:#dc2626}
  .delete-btn:hover{color:#b91c1c}

  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm)}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}

  @media (max-width:980px){
    .wrap{grid-template-columns:1fr}
    canvas{height:300px}
    .row-top{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .list-head{display:none}
    .list{max-height:none;padding:8px}
    .list-row{grid-template-columns:repeat(2,minmax(0,1fr));grid-template-areas:
      "cycle time"
      "problems problems"
      "delete delete"}
    .list-row .cycle{grid-area:cycle}
    .list-row .time{grid-area:time}
    .list-row .problems{grid-area:problems}
    .list-row .delete-cell{grid-area:delete;text-align:right}
    .btn.small{padding:6px 8px}
    .flagbtn{padding:4px 8px}
  }
</style>
</head>
<body>
<div class="app">

  <!-- Menyrad (kompakt, wrappar) -->
  <div class="menubar">
    <div class="logo">20 Cycle Check</div>
    <div class="menu-actions">
      <div class="langbar" id="langbar">
        <button class="flagbtn active" data-lang="sv"><span class="flag">üá∏üá™</span>SV</button>
        <button class="flagbtn" data-lang="en"><span class="flag">üá¨üáß</span>EN</button>
      </div>
      <button id="btnTheme" class="btn small">Tema: Auto</button>
      <button id="btnExport" class="btn small">Export to Excel (CSV)</button>
      <button id="btnReset" class="btn small danger">Nollst√§ll</button>
    </div>
  </div>

  <!-- Inputs + timer + Start/Varv + Stopp -->
  <div class="row-top">
    <div class="card pad">
      <div class="process-grid">
        <div>
          <label id="lblProcess">PROCESS</label>
          <input id="process" type="text" placeholder="Ange processnamn‚Ä¶">
        </div>
        <div>
          <label id="lblDate">DATE</label>
          <input id="date" type="text" placeholder="yyyy-mm-dd">
        </div>
      </div>
      <div style="margin-top:6px" class="toolbar">
        <button id="btnToggle" class="btn primary">Start</button>
        <button id="btnStop" class="btn secondary" disabled>Stoppa</button>
        <div id="status" class="status">Status: redo.</div>
      </div>
    </div>

    <div class="card pad card-meta">
      <div class="timer" id="timerDisp">00:00.00</div>
    </div>
  </div>

  <!-- Diagram + lista -->
  <div class="wrap">
    <div class="card">
      <div class="chart-wrap">
        <canvas id="chart" height="360"></canvas>
      </div>
      <div style="padding:6px 8px;color:#334155;background:#f8fafc;border-top:1px solid #e5e7eb;border-bottom-left-radius:10px;border-bottom-right-radius:10px;font-size:var(--fs-sm)">
        <span id="help1"></span>
      </div>
    </div>

    <div class="card pad">
      <div class="list-head">
        <div id="thCycle">CYCLE</div>
        <div id="thTime">TIME(S)</div>
        <div id="thProblems">OBSERVED PROBLEMS</div>
        <div> </div>
      </div>
      <div id="list" class="list"></div>

      <div style="padding:8px">
        <div class="kpis">
          <div class="pill"><span id="kpiAvgLabel"></span> <b id="kpiAvg">00:00.00</b></div>
          <div class="pill"><span id="kpiBrctLabel"></span> <b id="kpiBrct">‚Äì</b></div>
          <div class="pill"><span id="kpiDLabel"></span> <b id="kpiD">0.0%</b></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== i18n ===== */
const L={
  sv:{PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Ange processnamn‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TOGGLE_START:"Start",TOGGLE_LAP:"Varv",STOP:"Stoppa",RESET:"Nollst√§ll",EXPORT:"Exportera till Excel (CSV)",THEME_AUTO:"Tema: Auto",THEME_LIGHT:"Tema: Ljust",THEME_DARK:"Tema: M√∂rkt",
      STATUS_PREFIX:"Status: ",READY:"redo.",MEASURE:"M√§ter‚Ä¶",SAVED:"Sparad.",STOPPED:"Stoppad.",RESETTED:"√Öterst√§lld.",
      CONFIRM_RESET:"√Ñr du s√§ker p√• att du vill nollst√§lla hela m√§tningen?",
      HELP:"Y-axel auto efter l√§ngsta cykel. Staplar = cykler. Orange = √ò CT. Gr√∂n = BRCT (5 snabbaste). Tips: üóëÔ∏è = radera rad.",
      CYCLE:"CYCLE",TIMES:"TIME(S)",PROBLEMS:"OBSERVED PROBLEMS",
      KPI_AVG:"√ò CT (medel):",KPI_BRCT:"BRCT (5 snabbaste):",KPI_D:"D %:",CSV_DECIMAL:","},
  en:{PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Enter process name‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TOGGLE_START:"Start",TOGGLE_LAP:"Lap",STOP:"Stop",RESET:"Reset",EXPORT:"Export to Excel (CSV)",THEME_AUTO:"Theme: Auto",THEME_LIGHT:"Theme: Light",THEME_DARK:"Theme: Dark",
      STATUS_PREFIX:"Status: ",READY:"ready.",MEASURE:"Measuring‚Ä¶",SAVED:"Saved.",STOPPED:"Stopped.",RESETTED:"Reset.",
      CONFIRM_RESET:"Are you sure you want to reset the entire measurement?",
      HELP:"Y-axis auto to longest cycle. Bars = cycles. Orange = √ò CT. Green = BRCT (5 fastest). Tip: üóëÔ∏è = delete row.",
      CYCLE:"CYCLE",TIMES:"TIME(S)",PROBLEMS:"OBSERVED PROBLEMS",
      KPI_AVG:"√ò CT (mean):",KPI_BRCT:"BRCT (5 fastest):",KPI_D:"D %:",CSV_DECIMAL:"."}
};
let lang='sv';
const $=s=>document.querySelector(s);

/* ===== Theme ===== */
let theme='auto';
function applyTheme(mode){
  if(mode==='dark'){
    document.documentElement.style.setProperty('--bg','#0b1220');
    document.documentElement.style.setProperty('--paper','#0f172a');
    document.documentElement.style.setProperty('--ink','#e5e7eb');
    document.documentElement.style.setProperty('--line','#1f2937');
  }else if(mode==='light'){
    document.documentElement.style.setProperty('--bg','#f7f7f9');
    document.documentElement.style.setProperty('--paper','#ffffff');
    document.documentElement.style.setProperty('--ink','#0f172a');
    document.documentElement.style.setProperty('--line','#e5e7eb');
  }else{
    applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'); return;
  }
  $('#btnTheme').textContent=theme==='auto'?L[lang].THEME_AUTO:(theme==='light'?L[lang].THEME_LIGHT:L[lang].THEME_DARK);
}

/* ===== Helpers ===== */
function pad(n,w=2){return String(n).padStart(w,'0')}
function formatMs(ms){const cs=Math.round(ms/10),m=Math.floor(cs/6000),s=Math.floor((cs%6000)/100),c=cs%100; return `${pad(m)}:${pad(s)}.${pad(c)}`}
function formatSecondsForCSV(ms){const secs=(ms/1000).toFixed(2); return lang==='en'?secs:secs.replace('.',L[lang].CSV_DECIMAL)}

/* ===== State ===== */
let laps=[]; // {ms,note}
let running=false, tStart=0, tick=null;
let selectedIndex=-1;

/* ===== UI refs ===== */
const toggleBtn=$('#btnToggle'), stopBtn=$('#btnStop'), timerDisp=$('#timerDisp'), statusEl=$('#status');
const chart=$('#chart'), ctx=chart.getContext('2d',{willReadFrequently:true});

/* ===== Status ===== */
function status(s){ statusEl.textContent = L[lang].STATUS_PREFIX + s; }

/* ===== i18n apply ===== */
function setLangTexts(){
  $('#lblProcess').textContent=L[lang].PROCESS;
  $('#lblDate').textContent=L[lang].DATE;
  $('#process').placeholder=L[lang].PH_PROCESS;
  $('#date').placeholder=L[lang].PH_DATE;
  $('#btnExport').textContent=L[lang].EXPORT;
  $('#btnReset').textContent=L[lang].RESET;
  $('#help1').textContent=L[lang].HELP;
  $('#thCycle').textContent=L[lang].CYCLE;
  $('#thTime').textContent=L[lang].TIMES;
  $('#thProblems').textContent=L[lang].PROBLEMS;
  toggleBtn.textContent = running ? L[lang].TOGGLE_LAP : L[lang].TOGGLE_START;
  stopBtn.textContent = L[lang].STOP;
  document.querySelectorAll('#langbar .flagbtn').forEach(b=> b.classList.toggle('active', b.dataset.lang===lang));
  renderList();
}

/* ===== Timer (Start / Lap / Stop) ===== */
function startTimer(){
  if(running) return;
  running=true;
  tStart=performance.now();
  timerDisp.textContent='00:00.00';
  tick=setInterval(()=>{ timerDisp.textContent = formatMs(performance.now()-tStart); }, 50);
  toggleBtn.textContent=L[lang].TOGGLE_LAP;
  stopBtn.disabled=false;
  status(L[lang].MEASURE);
}
function addLap(ms,note=''){ laps.push({ms,note}); renderList(); drawChart(); updateKPIs(); }
function lap(){ // spara & forts√§tt direkt
  if(!running) return;
  const elapsed=Math.max(10, performance.now()-tStart);
  addLap(elapsed);
  status(L[lang].SAVED);
  tStart=performance.now();
  timerDisp.textContent='00:00.00';
}
function stopTimer(){
  if(!running) return;
  clearInterval(tick); tick=null; running=false;
  stopBtn.disabled=true;
  timerDisp.textContent='00:00.00';
  toggleBtn.textContent=L[lang].TOGGLE_START;
  status(L[lang].STOPPED);
}
function toggle(){ running ? lap() : startTimer(); }

toggleBtn.addEventListener('click', toggle);
stopBtn.addEventListener('click', stopTimer);

/* ===== Tangentbord ===== */
window.addEventListener('keydown', e=>{
  const ae=document.activeElement;
  const tag=ae && ae.tagName ? ae.tagName.toUpperCase(): '';
  if(e.code==='Space'){
    if(e.repeat){ e.preventDefault(); return; }
    if(tag==='TEXTAREA' || (tag==='INPUT' && (ae.type||'').toLowerCase()!=='button')) return;
    e.preventDefault();
    running ? lap() : startTimer();
  }
  if(e.key.toLowerCase()==='s'){ // s = stop
    if(tag!=='TEXTAREA' && tag!=='INPUT'){ e.preventDefault(); stopTimer(); }
  }
  if(e.key==='Delete' || e.key==='Backspace'){
    if(tag==='TEXTAREA' || tag==='INPUT'){ return; }
    e.preventDefault();
    deleteSelected();
  }
});

/* ===== Markera & radera rader ===== */
function selectRow(ix){
  selectedIndex=ix;
  document.querySelectorAll('.list-row').forEach((r,i)=> r.classList.toggle('selected', i===ix));
}
function deleteSelected(){
  if(selectedIndex<0 || selectedIndex>=laps.length) return;
  laps.splice(selectedIndex,1);
  selectedIndex=-1;
  renderList(); drawChart(); updateKPIs();
}

/* ===== Lista/KPI/Diagram ===== */
function renderList(){
  const list=$('#list'); list.innerHTML='';
  laps.forEach((l,i)=>{
    const row=document.createElement('div'); row.className='list-row';
    if(i===selectedIndex) row.classList.add('selected');
    row.innerHTML=
      `<div class="cell cycle"><span class="badge">#${i+1}</span></div>
       <div class="cell time"><b>${formatMs(l.ms)}</b></div>
       <div class="cell problems">
         <textarea data-ix="${i}" placeholder=""></textarea>
       </div>
       <div class="delete-cell"><button class="delete-btn" title="Delete" data-ix="${i}">üóëÔ∏è</button></div>`;
    list.appendChild(row);
    const ta=row.querySelector('textarea'); ta.value=l.note||'';
    row.addEventListener('click', ()=> selectRow(i));
    ta.addEventListener('focus', ()=> selectRow(i));
    ta.addEventListener('input', e=>{ const ix=+e.target.dataset.ix; laps[ix].note=e.target.value; });
  });
  list.querySelectorAll('.delete-btn').forEach(btn=>btn.addEventListener('click',e=>{
    e.stopPropagation();
    const ix=+e.currentTarget.dataset.ix;
    laps.splice(ix,1);
    if(selectedIndex===ix) selectedIndex=-1; else if(selectedIndex>ix) selectedIndex--;
    renderList(); drawChart(); updateKPIs();
  }));
}
function avgMs(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length:0}
function brctMs(a){ if(a.length<5) return null; return avgMs([...a].sort((x,y)=>x-y).slice(0,5)); }
function updateKPIs(){
  const arr=laps.map(x=>x.ms), avg=avgMs(arr), br=brctMs(arr);
  $('#kpiAvg').textContent=arr.length?formatMs(Math.round(avg)):'00:00.00';
  $('#kpiBrct').textContent=br!==null?formatMs(Math.round(br)):'‚Äì';
  const D=(avg>0&&br!==null)?((avg-br)/avg*100):0; $('#kpiD').textContent=`${D.toFixed(1)}%`;
}

/* ===== Diagram (bl√• nyanser p√• staplarna) ===== */
function drawChart(){
  const dpr=window.devicePixelRatio||1, W=chart.clientWidth*dpr, H=chart.clientHeight*dpr;
  chart.width=W; chart.height=H; ctx.clearRect(0,0,W,H);
  const padL=64*dpr, padR=16*dpr, padT=14*dpr, padB=34*dpr, innerW=W-padL-padR, innerH=H-padT-padB;
  const maxMs=Math.max(10000,...laps.map(l=>l.ms));
  const maxS=Math.ceil(maxMs/10000)*10;
  const msToY = ms => padT+innerH-(ms/(maxS*1000))*innerH;

  // ram
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1*dpr; ctx.strokeRect(padL,padT,innerW,innerH);

  // grid / Y-etiketter var 30s
  ctx.fillStyle='#475569'; ctx.font=`${11*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
  for(let s=0;s<=maxS;s+=30){
    const y=msToY(s*1000);
    ctx.strokeStyle=s===0?'#cbd5e1':'#e5e7eb';
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    const m=Math.floor(s/60), sec=s%60;
    ctx.textAlign='left'; ctx.textBaseline='middle';
    ctx.fillText(`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`,8*dpr,y);
  }

  // staplar ‚Äì bl√• palett (nyanser)
  const n=laps.length;
  if(n){
    const gap=6*dpr, bw=Math.max(8*dpr,(innerW-gap*(n-1))/n);
    for(let i=0;i<n;i++){
      const l=laps[i];
      const x=padL+i*(bw+gap), y=msToY(l*
