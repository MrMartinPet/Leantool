<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>20-Cycle-Check â€” Process Observation</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f7f7f9; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb;
    --radius:10px; --tap:40px; --fs:clamp(13px,2.2vw,15px); --fs-sm:clamp(11px,1.9vw,13px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;font-size:var(--fs);background:var(--bg);color:var(--ink)}
  .app{min-height:100%;padding:8px}
  .grid{display:grid;gap:8px}
  .row-top{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:end}
  .process-grid{display:grid;grid-template-columns:1fr 160px;gap:8px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius)}
  .pad{padding:8px}
  .card-meta{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
  label{font-size:var(--fs-sm);color:var(--muted)}
  input[type=text]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:var(--tap);padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;color:inherit;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#1d4ed8}
  .btn.danger{background:#fee2e2;border-color:#fecaca}
  .btn.small{min-height:34px;padding:6px 10px;font-size:var(--fs-sm)}
  .toolbar{display:flex;flex-wrap:wrap;gap:6px}
  .status{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;color:var(--muted);font-size:var(--fs-sm)}
  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:8px;margin-top:8px}
  .chart-wrap{padding:6px}
  canvas{width:100%;height:360px;display:block}
  .list-head,.list-row{display:grid;grid-template-columns:48px 96px 1fr;gap:6px;align-items:center}
  .list-head{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);padding:6px 8px;font-weight:600;z-index:1}
  .list{max-height:460px;overflow:auto;border-top:1px solid var(--line)}
  .list-row{padding:6px 8px;border-bottom:1px solid var(--line);background:#fff}
  textarea{width:100%;min-height:36px;border:1px solid var(--line);border-radius:8px;padding:6px;font:inherit;font-size:var(--fs-sm)}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm)}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
  .timer{font-weight:800;font-size:16px;background:#0a0;color:#fff;padding:6px 10px;border-radius:8px;text-align:center;white-space:nowrap}
  .langbar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .flagbtn{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:62px;padding:6px;border:1px solid var(--line);border-radius:8px;background:#fff;font-size:var(--fs-sm)}
  .flagbtn.active{background:#eef2ff;border-color:#c7d2fe}
  .flag{font-size:18px;line-height:1}
  .list-row .cell.problems textarea{width:100%}
  @media (max-width: 980px){
    .wrap{grid-template-columns:1fr}
    canvas{height:300px}
    .row-top{grid-template-columns:1fr auto}
  }
  @media (max-width: 720px){
    .row-top{grid-template-columns:1fr}
    .card-meta{align-items:stretch}
    .card-meta .langbar{justify-content:center}
    .card-meta .timer{width:100%}
  }
  @media (max-width: 640px){
    .app{padding:12px 10px}
    .process-grid{grid-template-columns:1fr}
    .toolbar{display:grid;grid-template-columns:repeat(2,minmax(0,1fr))}
    .toolbar .btn{width:100%}
    .status{grid-column:1/-1;text-align:center}
    .wrap{gap:12px}
    canvas{height:240px}
    .list-head{display:none}
    .list{max-height:none}
    .list-row{grid-template-columns:repeat(2,minmax(0,1fr));grid-template-areas:'cycle time' 'problems problems';align-items:start;gap:8px}
    .list-row .cell{display:flex;flex-direction:column;gap:2px}
    .list-row .cell::before{content:attr(data-label);font-size:var(--fs-sm);color:var(--muted);font-weight:500}
    .list-row .cycle{grid-area:cycle}
    .list-row .time{grid-area:time}
    .list-row .problems{grid-area:problems}
    .list-row textarea{min-height:64px}
    .kpis{grid-template-columns:1fr}
  }
  @media (max-width: 480px){
    .toolbar{grid-template-columns:1fr}
    .langbar{justify-content:center}
    .flagbtn{flex:1 1 auto;min-width:0}
    .card-meta{gap:8px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Topp: process + datum + sprÃ¥k + tema + timer -->
  <div class="row-top">
    <div class="card pad">
      <div class="process-grid">
        <div>
          <label id="lblProcess">PROCESS</label>
          <input id="process" type="text" placeholder="Ange processnamnâ€¦">
        </div>
        <div>
          <label id="lblDate">DATE</label>
          <input id="date" type="text" placeholder="yyyy-mm-dd">
        </div>
      </div>
      <div style="margin-top:6px" class="toolbar">
        <button id="btnToggle" class="btn primary">Start</button>
        <button id="btnAdd" class="btn small">+ Manuell</button>
        <button id="btnReset" class="btn small danger">NollstÃ¤ll</button>
        <button id="btnExport" class="btn small">Export CSV</button>
        <div id="status" class="status">Status: redo.</div>
      </div>
    </div>

    <div class="card pad card-meta">
      <div class="langbar" id="langbar" aria-label="Language">
        <button class="flagbtn" data-lang="en"><span class="flag">ðŸ‡¬ðŸ‡§</span><span>English</span></button>
        <button class="flagbtn" data-lang="de"><span class="flag">ðŸ‡©ðŸ‡ª</span><span>Deutsch</span></button>
        <button class="flagbtn active" data-lang="sv"><span class="flag">ðŸ‡¸ðŸ‡ª</span><span>Svenska</span></button>
      </div>
      <button id="btnTheme" class="btn small">Tema: Auto</button>
      <div class="timer" id="timerDisp">00:00.00</div>
    </div>
  </div>

  <!-- Mitten: Diagram + lista -->
  <div class="wrap">
    <div class="card">
      <div class="chart-wrap">
        <canvas id="chart" height="360"></canvas>
      </div>
      <div style="padding:6px 8px;color:#334155;background:#f8fafc;border-top:1px solid #e5e7eb;border-bottom-left-radius:10px;border-bottom-right-radius:10px;font-size:var(--fs-sm)">
        <span id="help1">Y-axel auto efter lÃ¤ngsta cykel. Staplar = cykler. Orange = Ã˜ CT. GrÃ¶n streck = BRCT (5 snabbaste).</span>
      </div>
    </div>

    <div class="card pad">
      <div class="list-head">
        <div id="thCycle">CYCLE</div>
        <div id="thTime">TIME(S)</div>
        <div id="thProblems">OBSERVED PROBLEMS</div>
      </div>
      <div id="list" class="list"></div>

      <div style="padding:8px">
        <div class="kpis">
          <div class="pill"><span id="kpiAvgLabel">Ã˜ CT (medel):</span> <b id="kpiAvg">00:00.00</b></div>
          <div class="pill"><span id="kpiBrctLabel">BRCT (5 snabbaste):</span> <b id="kpiBrct">â€“</b></div>
          <div class="pill"><span id="kpiDLabel">D %:</span> <b id="kpiD">0.0%</b></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== i18n ===== */
const L = {
  sv:{ PROCESS:"PROCESS", DATE:"DATE", PH_PROCESS:"Ange processnamnâ€¦", PH_DATE:"yyyy-mm-dd",
    TOGGLE_START:"Start", TOGGLE_STOP:"Stoppa & spara", ADD:"+ Manuell", RESET:"NollstÃ¤ll", EXPORT:"Export CSV",
    STATUS_PREFIX:"Status: ", READY:"redo.", MEASURE:"MÃ¤terâ€¦", SAVED:"Sparad.", STOPPED:"Stoppad.", RESETTED:"Ã…terstÃ¤lld.",
    HELP:"Y-axel auto efter lÃ¤ngsta cykel. Staplar = cykler. Orange = Ã˜ CT. GrÃ¶n streck = BRCT (5 snabbaste).",
    CYCLE:"CYCLE", TIMES:"TIME(S)", PROBLEMS:"OBSERVED PROBLEMS",
    KPI_AVG:"Ã˜ CT (medel):", KPI_BRCT:"BRCT (5 snabbaste):", KPI_D:"D %:",
    PROMPT_TIME:"Tid (mm:ss eller sekunder, t.ex. 02:35 eller 155.2):",
    ERR_TIME:"Ogiltig tid.",
    THEME_AUTO:"Tema: Auto", THEME_LIGHT:"Tema: Ljust", THEME_DARK:"Tema: MÃ¶rkt",
    CSV_DECIMAL:","
  },
  en:{ PROCESS:"PROCESS", DATE:"DATE", PH_PROCESS:"Enter process nameâ€¦", PH_DATE:"yyyy-mm-dd",
    TOGGLE_START:"Start", TOGGLE_STOP:"Stop & Save", ADD:"+ Manual", RESET:"Reset", EXPORT:"Export CSV",
    STATUS_PREFIX:"Status: ", READY:"ready.", MEASURE:"Measuringâ€¦", SAVED:"Saved.", STOPPED:"Stopped.", RESETTED:"Reset.",
    HELP:"Y-axis auto to longest cycle. Bars = cycles. Orange = Ã˜ CT. Green dashed = BRCT (5 fastest).",
    CYCLE:"CYCLE", TIMES:"TIME(S)", PROBLEMS:"OBSERVED PROBLEMS",
    KPI_AVG:"Ã˜ CT (mean):", KPI_BRCT:"BRCT (5 fastest):", KPI_D:"D %:",
    PROMPT_TIME:"Time (mm:ss or seconds, e.g., 02:35 or 155.2):",
    ERR_TIME:"Invalid time.",
    THEME_AUTO:"Theme: Auto", THEME_LIGHT:"Theme: Light", THEME_DARK:"Theme: Dark",
    CSV_DECIMAL:"."
  },
  de:{ PROCESS:"PROZESS", DATE:"DATUM", PH_PROCESS:"Prozessname eingebenâ€¦", PH_DATE:"jjjj-mm-tt",
    TOGGLE_START:"Start", TOGGLE_STOP:"Stoppen & speichern", ADD:"+ Manuell", RESET:"ZurÃ¼cksetzen", EXPORT:"CSV exportieren",
    STATUS_PREFIX:"Status: ", READY:"bereit.", MEASURE:"Messungâ€¦", SAVED:"Gespeichert.", STOPPED:"Gestoppt.", RESETTED:"ZurÃ¼ckgesetzt.",
    HELP:"Y-Achse automatisch zur lÃ¤ngsten Zykluszeit. Balken = Zyklen. Orange = Ã˜ CT. GrÃ¼n gestrichelt = BRCT (5 schnellste).",
    CYCLE:"ZYKLUS", TIMES:"ZEIT(S)", PROBLEMS:"BEOBACHTETE PROBLEME",
    KPI_AVG:"Ã˜ CT (Mittel):", KPI_BRCT:"BRCT (5 schnellste):", KPI_D:"D %:",
    PROMPT_TIME:"Zeit (mm:ss oder Sekunden, z. B. 02:35 oder 155.2):",
    ERR_TIME:"UngÃ¼ltige Zeit.",
    THEME_AUTO:"Thema: Auto", THEME_LIGHT:"Thema: Hell", THEME_DARK:"Thema: Dunkel",
    CSV_DECIMAL:","
  }
};
let lang = 'sv';
const $ = s => document.querySelector(s);
const toggleBtn = $('#btnToggle');
function setLangTexts(){
  $('#lblProcess').textContent = L[lang].PROCESS;
  $('#lblDate').textContent = L[lang].DATE;
  $('#process').placeholder = L[lang].PH_PROCESS;
  $('#date').placeholder = L[lang].PH_DATE;
  toggleBtn.textContent = running ? L[lang].TOGGLE_STOP : L[lang].TOGGLE_START;
  $('#btnAdd').textContent = L[lang].ADD;
  $('#btnReset').textContent = L[lang].RESET;
  $('#btnExport').textContent = L[lang].EXPORT;
  $('#help1').textContent = L[lang].HELP;
  $('#thCycle').textContent = L[lang].CYCLE;
  $('#thTime').textContent = L[lang].TIMES;
  $('#thProblems').textContent = L[lang].PROBLEMS;
  $('#kpiAvgLabel').textContent = L[lang].KPI_AVG;
  $('#kpiBrctLabel').textContent = L[lang].KPI_BRCT;
  $('#kpiDLabel').textContent = L[lang].KPI_D;
  document.querySelectorAll('#langbar .flagbtn').forEach(b=> b.classList.toggle('active', b.dataset.lang===lang));
  renderList();
}

let theme='auto';
function applyTheme(mode){
  if(mode==='dark'){
    document.documentElement.style.setProperty('--bg','#0b1220');
    document.documentElement.style.setProperty('--paper','#0f172a');
    document.documentElement.style.setProperty('--ink','#e5e7eb');
    document.documentElement.style.setProperty('--line','#1f2937');
  }else if(mode==='light'){
    document.documentElement.style.setProperty('--bg','#f7f7f9');
    document.documentElement.style.setProperty('--paper','#ffffff');
    document.documentElement.style.setProperty('--ink','#0f172a');
    document.documentElement.style.setProperty('--line','#e5e7eb');
  }else{
    applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'); return;
  }
  $('#btnTheme').textContent = theme==='auto' ? L[lang].THEME_AUTO : (theme==='light'?L[lang].THEME_LIGHT:L[lang].THEME_DARK);
}

/* ===== Helpers ===== */
function pad(n,w=2){return String(n).padStart(w,'0')}
function formatMs(ms){const cs=Math.round(ms/10),m=Math.floor(cs/6000),s=Math.floor((cs%6000)/100),c=cs%100; return `${pad(m)}:${pad(s)}.${pad(c)}`}
function parseHuman(s){
  s=(s||'').trim().replace(',', '.'); if(!s) return null;
  if(/^\d+(\.\d+)?$/.test(s)) return Math.round(parseFloat(s)*1000);
  const m=s.match(/^(\d{1,2}):(\d{2})(?:\.(\d{1,2}))?$/); if(!m) return null;
  const mm=+m[1], ss=+m[2], cc=m[3]? +m[3].padEnd(2,'0'):0; return ((mm*60)+ss)*1000 + Math.round(cc*10);
}
function formatSecondsForCSV(ms){const secs=(ms/1000).toFixed(2); return lang==='en'?secs:secs.replace('.',L[lang].CSV_DECIMAL)}

/* ===== State ===== */
let laps=[]; // {ms,note}
let running=false, tStart=0, tick=null;

/* ===== UI ===== */
const timerDisp=$('#timerDisp'), statusEl=$('#status'), chart=$('#chart'), ctx=chart.getContext('2d',{willReadFrequently:true});
function status(s){ statusEl.textContent = L[lang].STATUS_PREFIX + s; }

/* ===== Timer Toggle ===== */
function toggle(){
  if(!running){
    running=true; tStart=performance.now();
    tick=setInterval(()=>{ timerDisp.textContent = formatMs(performance.now()-tStart); }, 50);
    toggleBtn.textContent=L[lang].TOGGLE_STOP; status(L[lang].MEASURE);
  }else{
    clearInterval(tick); tick=null; running=false;
    const ms=Math.max(10, performance.now()-tStart);
    addLap(ms);
    timerDisp.textContent='00:00.00';
    toggleBtn.textContent=L[lang].TOGGLE_START; status(L[lang].SAVED);
  }
}
toggleBtn.addEventListener('click', toggle);

function allowSpaceToggle(active){
  if(!active || active===document.body || active===document.documentElement) return true;
  if(active===toggleBtn) return true;
  if(active.isContentEditable) return false;
  if(active.tagName){
    const tag=active.tagName.toUpperCase();
    if(tag==='TEXTAREA') return false;
    if(tag==='INPUT'){ const type=(active.type||'').toLowerCase(); if(type && type!=='button' && type!=='submit') return false; }
    if(tag==='BUTTON') return active===toggleBtn;
  }
  return false;
}

window.addEventListener('keydown', e=>{
  if(e.code!=='Space') return;
  if(e.repeat){ e.preventDefault(); return; }
  if(!allowSpaceToggle(document.activeElement)) return;
  e.preventDefault();
  toggle();
});

/* ===== Laps/List/Stats ===== */
function addLap(ms,note=''){ laps.push({ms,note}); renderList(); drawChart(); updateKPIs(); }
function renderList(){
  const list=$('#list'); list.innerHTML='';
  laps.forEach((l,i)=>{
    const row=document.createElement('div'); row.className='list-row';
    row.innerHTML=`<div class="cell cycle" data-label="${L[lang].CYCLE}">${i+1}</div><div class="cell time" data-label="${L[lang].TIMES}">${formatMs(l.ms)}</div><div class="cell problems" data-label="${L[lang].PROBLEMS}"><textarea data-ix="${i}">${l.note||''}</textarea></div>`;
    list.appendChild(row);
  });
  list.querySelectorAll('textarea').forEach(t=> t.addEventListener('input', e=>{ const ix=+e.target.dataset.ix; laps[ix].note=e.target.value; }));
}
function avgMs(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length:0}
function brctMs(a){ if(a.length<5) return null; return avgMs([...a].sort((x,y)=>x-y).slice(0,5)); }
function updateKPIs(){
  const arr=laps.map(x=>x.ms), avg=avgMs(arr), br=brctMs(arr);
  $('#kpiAvg').textContent=formatMs(Math.round(avg)||0);
  $('#kpiBrct').textContent=br!==null?formatMs(Math.round(br)):'â€“';
  const D=(avg>0&&br!==null)?((avg-br)/avg*100):0; $('#kpiD').textContent=`${D.toFixed(1)}%`;
}

/* ===== Chart ===== */
function drawChart(){
  const dpr=window.devicePixelRatio||1, W=chart.clientWidth*dpr, H=chart.clientHeight*dpr;
  chart.width=W; chart.height=H; ctx.clearRect(0,0,W,H);
  const padL=64*dpr, padR=16*dpr, padT=14*dpr, padB=34*dpr, innerW=W-padL-padR, innerH=H-padT-padB;
  const maxMs=Math.max(10000,...laps.map(l=>l.ms)); const maxS=Math.ceil(maxMs/10000)*10; const msToY = ms => padT+innerH-(ms/(maxS*1000))*innerH;
  // frame
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1*dpr; ctx.strokeRect(padL,padT,innerW,innerH);
  // grid y/30s
  ctx.fillStyle='#475569'; ctx.font=`${11*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
  for(let s=0;s<=maxS;s+=30){ const y=msToY(s*1000); ctx.strokeStyle=s===0?'#cbd5e1':'#e5e7eb'; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    const m=Math.floor(s/60), sec=s%60; ctx.textAlign='left'; ctx.textBaseline='middle'; ctx.fillText(`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`,8*dpr,y); }
  // bars
  const n=laps.length; if(n){ const gap=6*dpr, bw=Math.max(8*dpr,(innerW-gap*(n-1))/n); ctx.fillStyle='rgba(71,85,105,.75)';
    laps.forEach((l,i)=>{ const x=padL+i*(bw+gap), y=msToY(l.ms), h=padT+innerH-y; ctx.fillRect(x,y,bw,h); });
    // x labels
    ctx.fillStyle='#475569'; ctx.textAlign='center'; ctx.textBaseline='top';
    for(let i=0;i<n;i++){ const gap2=6*dpr, bw2=Math.max(8*dpr,(innerW-gap2*(n-1))/n); const x=padL+i*(bw2+gap2)+bw2/2; ctx.fillText(String(i+1), x, H-padB+6*dpr); }
  }
  // mean line
  if(laps.length){ const mean=avgMs(laps.map(l=>l.ms)); const y=msToY(mean); ctx.strokeStyle='#f59e0b'; ctx.lineWidth=2*dpr; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); }
  // BRCT
  if(laps.length>=5){ const br=brctMs(laps.map(l=>l.ms)); const y=msToY(br); ctx.strokeStyle='#22c55e'; ctx.setLineDash([5*dpr,5*dpr]); ctx.lineWidth=2*dpr; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke(); ctx.setLineDash([]); }
}

/* ===== Buttons ===== */
$('#btnAdd').addEventListener('click', ()=>{
  const s=prompt(L[lang].PROMPT_TIME,''); const ms=parseHuman(s);
  if(ms==null || !isFinite(ms) || ms<=0){ alert(L[lang].ERR_TIME); return; }
  addLap(ms); status(L[lang].SAVED);
});
$('#btnReset').addEventListener('click', ()=>{
  if(running){ toggle(); } laps=[]; renderList(); drawChart(); updateKPIs(); status(L[lang].RESETTED); timerDisp.textContent='00:00.00';
});
$('#btnExport').addEventListener('click', ()=>{
  const headers=['Process','Date','Cycle','Time_mm:ss.cc','Time_s','Observed_problems'];
  const proc=$('#process').value||'', dat=$('#date').value||'';
  const rows=laps.map((l,i)=>[`"${proc}"` , `"${dat}"`, `"${i+1}"`, `"${formatMs(l.ms)}"`, `"${formatSecondsForCSV(l.ms)}"`, `"${(l.note||'').replaceAll('"','""')}"`].join(';'));
  const csv=headers.join(';')+'\r\n'+rows.join('\r\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); const ts=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); a.href=URL.createObjectURL(blob); a.download=`20-cycle-check_${ts}.csv`; a.click(); URL.revokeObjectURL(a.href);
  status(L[lang].SAVED);
});

/* ===== Language & Theme ===== */
document.querySelectorAll('#langbar .flagbtn').forEach(b=> b.addEventListener('click', ()=>{ lang=b.dataset.lang; try{localStorage.setItem('leantool_lang',lang)}catch{}; setLangTexts(); }));
$('#btnTheme').addEventListener('click', ()=>{ theme=theme==='auto'?'light':theme==='light'?'dark':'auto'; try{localStorage.setItem('leantool_theme',theme)}catch{}; applyTheme(theme) });

/* ===== Init ===== */
(function init(){
  try{ lang = localStorage.getItem('leantool_lang') || (navigator.language||'sv').slice(0,2); if(!L[lang]) lang='sv'; }catch{}
  try{ theme = localStorage.getItem('leantool_theme') || 'auto'; }catch{}
  applyTheme(theme); setLangTexts();
  const d=new Date(); $('#date').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  drawChart();
  window.addEventListener('resize', drawChart);
})();
</script>
</body>
</html>
