<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>20 Cycle Check ‚Äî Process Observation</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f7f7f9; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb;
    --radius:10px; --tap:40px; --fs:clamp(13px,2.2vw,15px); --fs-sm:clamp(11px,1.9vw,13px);
    --blue-600:#2563eb; --blue-500:#3b82f6; --blue-400:#60a5fa; --blue-300:#93c5fd;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;font-size:var(--fs);background:var(--bg);color:var(--ink)}
  .app{min-height:100%;padding:8px}

  .menubar{
    display:flex;flex-wrap:wrap;align-items:center;gap:8px;
    background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);
    padding:6px 10px;margin-bottom:8px
  }
  .logo{font-weight:800;font-size:16px;white-space:nowrap;margin-right:auto}
  .menu-actions{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .langbtn{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm);cursor:pointer
  }
  .flag{font-size:16px;line-height:1}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:var(--tap);padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;color:inherit;cursor:pointer}
  .btn.primary{background:var(--blue-600);color:#fff;border-color:#1d4ed8}
  .btn.secondary{background:#fff;border-color:var(--line)}
  .btn.danger{background:#fee2e2;border-color:#fecaca}
  .btn.small{min-height:34px;padding:6px 10px;font-size:var(--fs-sm)}

  .top-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius)}
  .pad{padding:8px}
  label{font-size:var(--fs-sm);color:var(--muted)}
  input[type=text], input[type=number]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}

  .lang-card .row2{display:grid;grid-template-columns:1fr 140px 90px;gap:8px}

  .timer-card .controls{display:flex;gap:8px;align-items:center}
  .timer-card .controls > *{min-width:0}
  .timer-card .start{flex:0 0 35%}
  .timer-card .mid{flex:0 0 50%;display:flex;justify-content:center}
  .timer-card .stop{flex:0 0 15%}
  .timer{font-weight:800;font-size:18px;background:#0a0;color:#fff;padding:10px 12px;border-radius:8px;text-align:center;min-width:0;width:100%}

  .wrap{display:grid;grid-template-columns:1.2fr 0.8fr;gap:8px;margin-top:8px}
  .chart-card{display:flex;flex-direction:column}
  .chart-header{display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--line);padding-bottom:10px}
  .chart-title{margin:0;font-size:18px;font-weight:700;color:var(--ink)}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm)}
  .chart-wrap{padding:6px}
  canvas{width:100%;height:360px;display:block}

  .list-head,.list-row{display:grid;grid-template-columns:56px 110px 1fr 40px;gap:8px;align-items:center}
  .list-head{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px;font-weight:700;z-index:1}
  .list{max-height:460px;overflow:auto;border-top:1px solid var(--line);padding:8px}
  .list-row{
    padding:10px;background:#fff;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.04);
  }
  .list-row:nth-child(odd){background:#f9fbff}
  .list-row.selected{outline:2px solid #93c5fd;background:#eff6ff}
  .badge{display:inline-block;background:#e2e8f0;color:#334155;padding:4px 8px;border-radius:999px;font-size:var(--fs-sm);font-weight:600}
  textarea{width:100%;min-height:40px;border:1px solid var(--line);border-radius:8px;padding:6px;font:inherit;font-size:var(--fs-sm)}
  .delete-btn{cursor:pointer;border:none;background:none;font-size:18px;line-height:1;color:#dc2626}
  .delete-btn:hover{color:#b91c1c}

  @media (max-width:980px){
    .wrap{grid-template-columns:1fr}
    canvas{height:300px}
    .top-grid{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .kpis{grid-template-columns:1fr}
    .list-head{display:none}
    .list{max-height:none;padding:8px}
    .list-row{grid-template-columns:repeat(2,minmax(0,1fr));grid-template-areas:
      "cycle time"
      "problems problems"
      "delete delete"}
    .list-row .cycle{grid-area:cycle}
    .list-row .time{grid-area:time}
    .list-row .problems{grid-area:problems}
    .list-row .delete-cell{grid-area:delete;text-align:right}
    .timer-card .controls{gap:6px}
  }
</style>
</head>
<body>
<div class="app">

  <!-- Menyrad -->
  <div class="menubar">
    <div class="logo">20 Cycle Check</div>
    <div class="menu-actions">
      <button id="btnLang" class="langbtn"><span class="flag">üá∏üá™</span><span id="langLabel">SV</span></button>
      <button id="btnExport" class="btn small">Exportera</button>
      <button id="btnReport" class="btn small">Rapport (PDF)</button>
      <button id="btnReset" class="btn small danger">Nollst√§ll</button>
    </div>
  </div>

  <!-- Process/Datum/TAKT  |  Start/Timer/Stop -->
  <div class="top-grid">
    <div class="card pad lang-card">
      <div class="row2">
        <div>
          <label id="lblProcess">PROCESS</label>
          <input id="process" type="text" placeholder="Ange processnamn‚Ä¶">
        </div>
        <div>
          <label id="lblDate">DATE</label>
          <input id="date" type="text" placeholder="yyyy-mm-dd">
        </div>
        <div>
          <label id="lblTakt">TAKT</label>
          <!-- NEW: knapp f√∂r att r√§kna fram TAKT -->
          <div style="display:flex; gap:6px;">
            <input id="takt" type="number" min="0" step="1" placeholder="sek" style="flex:1">
            <button id="btnCalcTakt" class="btn small" type="button">Ber√§kna</button> <!-- NEW -->
          </div>
        </div>
      </div>
    </div>

    <div class="card pad timer-card">
      <div class="controls">
        <div class="start"><button id="btnToggle" class="btn primary" style="width:100%;font-size:16px;padding:12px 14px">Start</button></div>
        <div class="mid"><div class="timer" id="timerDisp">00:00.00</div></div>
        <div class="stop"><button id="btnStop" class="btn secondary" style="width:100%">Stoppa</button></div>
      </div>
    </div>
  </div>

  <!-- Diagram + KPI + Lista -->
  <div class="wrap">
    <div class="card chart-card">
      <div class="chart-header pad">
        <h3 id="resultsTitle" class="chart-title">Resultat</h3>
        <div class="kpis">
          <div class="pill"><span id="kpiAvgLabel"></span> <b id="kpiAvg">00:00.00</b></div>
          <div class="pill"><span id="kpiBrctLabel"></span> <b id="kpiBrct">‚Äì</b></div>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="chart" height="360"></canvas>
      </div>
    </div>

    <div class="card pad">
      <div class="list-head">
        <div id="thCycle">CYCLE</div>
        <div id="thTime">TIME(S)</div>
        <div id="thProblems">OBSERVED PROBLEMS</div>
        <div> </div>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>
</div>

<!-- jsPDF f√∂r PDF-export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===== i18n ===== */
const L={
  sv:{PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Ange processnamn‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TAKT:"TAKT", PH_TAKT:"sek", TAKT_LABEL:"Kundtakt:",
      TOGGLE_START:"Start",TOGGLE_LAP:"Varv",STOP:"Stoppa",RESET:"Nollst√§ll",EXPORT:"Exportera",REPORT:"Rapport (PDF)",
      RESULTS_TITLE:"Resultat",
      KPI_AVG:"√ò CT (medel):",KPI_BRCT:"BRCT (5 snabbaste):",
      KPI_AVG_SHORT:"√ò CT:",KPI_BRCT_SHORT:"BRCT:",CSV_DECIMAL:",",
      LONGEST:"L√§ngsta CT:", SHORTEST:"Kortaste CT:", DISTURBANCE:"D %:",
      CALC_TAKT_BTN:"Ber√§kna", /* NEW */
      PROMPT_VOLUME:"Ange √•rsvolym (antal enheter/√•r):", /* NEW */
      PROMPT_HOURS:"Ange arbetstid per vecka (timmar) ‚Äî 78 √§r standard:", /* NEW */
      ALERT_BAD_INPUT:"Ogiltiga v√§rden. F√∂rs√∂k igen." /* NEW */
  },
  en:{PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Enter process name‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TAKT:"TAKT", PH_TAKT:"sec", TAKT_LABEL:"Takt:",
      TOGGLE_START:"Start",TOGGLE_LAP:"Lap",STOP:"Stop",RESET:"Reset",EXPORT:"Export",REPORT:"Report (PDF)",
      RESULTS_TITLE:"Results",
      KPI_AVG:"√ò CT (mean):",KPI_BRCT:"BRCT (5 fastest):",
      KPI_AVG_SHORT:"√ò CT:",KPI_BRCT_SHORT:"BRCT:",CSV_DECIMAL:".",
      LONGEST:"Longest CT:", SHORTEST:"Shortest CT:", DISTURBANCE:"D %:",
      CALC_TAKT_BTN:"Calculate", /* NEW */
      PROMPT_VOLUME:"Enter annual volume (units/year):", /* NEW */
      PROMPT_HOURS:"Enter working hours per week ‚Äî 78 is default:", /* NEW */
      ALERT_BAD_INPUT:"Invalid values. Please try again." /* NEW */
  }
};
let lang='sv';
const $=s=>document.querySelector(s);

/* ===== Helpers ===== */
function pad(n,w=2){return String(n).padStart(w,'0')}
function formatMs(ms){const cs=Math.round(ms/10),m=Math.floor(cs/6000),s=Math.floor((cs%6000)/100),c=cs%100; return `${pad(m)}:${pad(s)}.${pad(c)}`}
function formatSecondsForCSV(ms){const secs=(ms/1000).toFixed(2); return lang==='en'?secs:secs.replace('.',L[lang].CSV_DECIMAL)}

/* ===== State ===== */
let laps=[];
let running=false, tStart=0, tick=null;
let selectedIndex=-1;
const STORAGE_KEY='cycle-check-state-v6';

let rafId=null;

/* ===== UI refs ===== */
const processInput=$('#process'), dateInput=$('#date'), taktInput=$('#takt');
const toggleBtn=$('#btnToggle'), stopBtn=$('#btnStop'), timerDisp=$('#timerDisp');
const chart=$('#chart');

/* ===== i18n apply ===== */
function setLangTexts(){
  $('#lblProcess').textContent=L[lang].PROCESS;
  $('#lblDate').textContent=L[lang].DATE;
  $('#lblTakt').textContent=L[lang].TAKT;
  $('#process').placeholder=L[lang].PH_PROCESS;
  $('#date').placeholder=L[lang].PH_DATE;
  taktInput.placeholder=L[lang].PH_TAKT;
  $('#btnExport').textContent=L[lang].EXPORT;
  $('#btnReport').textContent=L[lang].REPORT;
  $('#btnReset').textContent=L[lang].RESET;
  $('#resultsTitle').textContent=L[lang].RESULTS_TITLE;
  $('#kpiAvgLabel').textContent=L[lang].KPI_AVG;
  $('#kpiBrctLabel').textContent=L[lang].KPI_BRCT;
  toggleBtn.textContent = running ? L[lang].TOGGLE_LAP : L[lang].TOGGLE_START;
  stopBtn.textContent = L[lang].STOP;
  $('#langLabel').textContent = lang==='sv'?'SV':'EN';
  $('#btnLang').querySelector('.flag').textContent = lang==='sv'?'üá∏üá™':'üá¨üáß';
  document.getElementById('btnCalcTakt').textContent = L[lang].CALC_TAKT_BTN; /* NEW */
  renderList();
}

/* ===== Timer ===== */
function startTimer(){
  if(running) return;
  running=true;
  tStart=performance.now();
  timerDisp.textContent='00:00.00';
  if(tick) clearInterval(tick);
  tick=setInterval(()=>{ timerDisp.textContent = formatMs(performance.now()-tStart); }, 50);
  toggleBtn.textContent=L[lang].TOGGLE_LAP;
  stopBtn.disabled=false;
  startLoop();
}
function lap(){
  if(!running) return;
  const now = performance.now();
  const elapsed = Math.max(10, now - tStart);
  tStart = now;
  timerDisp.textContent = '00:00.00';
  laps.push({ms: elapsed, note: ''});
  selectedIndex = laps.length - 1;
  refreshUI();
}
function stopTimer(){
  if(running){
    running=false;
    if(tick){ clearInterval(tick); tick=null; }
    toggleBtn.textContent=L[lang].TOGGLE_START;
  }
  stopBtn.disabled=true;
  timerDisp.textContent='00:00.00';
  stopLoop();
  refreshUI();
}
function toggle(){ running ? lap() : startTimer(); }
toggleBtn.addEventListener('click', toggle);
stopBtn.addEventListener('click', stopTimer);

/* ===== Tangentbord ===== */
window.addEventListener('keydown', e=>{
  const ae=document.activeElement;
  const tag=ae && ae.tagName ? ae.tagName.toUpperCase(): '';
  if(e.code==='Space'){
    if(e.repeat){ e.preventDefault(); return; }
    if(tag==='TEXTAREA' || (tag==='INPUT' && (ae.type||'').toLowerCase()!=='button')) return;
    e.preventDefault();
    running ? lap() : startTimer();
  }
  if(e.key && e.key.toLowerCase()==='s'){
    if(tag!=='TEXTAREA' && tag!=='INPUT'){ e.preventDefault(); stopTimer(); }
  }
  if(e.key==='Delete' || e.key==='Backspace'){
    if(tag==='TEXTAREA' || tag==='INPUT'){ return; }
    e.preventDefault();
    deleteSelected();
  }
});

/* ===== Markera & radera rader ===== */
function selectRow(ix){
  selectedIndex=ix;
  document.querySelectorAll('.list-row').forEach((r,i)=> r.classList.toggle('selected', i===ix));
}
function deleteSelected(){
  if(selectedIndex<0 || selectedIndex>=laps.length) return;
  laps.splice(selectedIndex,1);
  selectedIndex=-1;
  refreshUI();
}

/* ===== Lista/KPI ===== */
function renderList(){
  const list=$('#list'); list.innerHTML='';
  laps.forEach((l,i)=>{
    const row=document.createElement('div'); row.className='list-row';
    if(i===selectedIndex) row.classList.add('selected');
    row.innerHTML=
      `<div class="cell cycle"><span class="badge">${i+1}</span></div>
       <div class="cell time"><b>${formatMs(l.ms)}</b></div>
       <div class="cell problems">
         <textarea data-ix="${i}" placeholder="Notes / Problem"></textarea>
       </div>
       <div class="delete-cell"><button class="delete-btn" title="Delete" data-ix="${i}">üóëÔ∏è</button></div>`;
    list.appendChild(row);
    const ta=row.querySelector('textarea'); ta.value=l.note||'';
    row.addEventListener('click', ()=> selectRow(i));
    ta.addEventListener('focus', ()=> selectRow(i));
    ta.addEventListener('input', e=>{ const ix=+e.target.dataset.ix; laps[ix].note=e.target.value; saveState(); });
  });
  list.querySelectorAll('.delete-btn').forEach(btn=>btn.addEventListener('click',e=>{
    e.stopPropagation();
    const ix=+e.currentTarget.dataset.ix;
    laps.splice(ix,1);
    if(selectedIndex===ix) selectedIndex=-1; else if(selectedIndex>ix) selectedIndex--;
    refreshUI();
  }));
}

function avgMs(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length:0}
function brctMs(a){ if(a.length<5) return null; return avgMs([...a].sort((x,y)=>x-y).slice(0,5)); }
function longestMs(arr){ return arr.length ? Math.max(...arr) : 0; }
function shortestMs(arr){ return arr.length ? Math.min(...arr) : 0; }
function disturbanceRate(avg, br){ return (avg>0 && br!==null) ? ((avg - br)/avg*100) : 0; }

function updateKPIs(){
  const arr=laps.map(x=>x.ms), avg=avgMs(arr), br=brctMs(arr);
  $('#kpiAvg').textContent=arr.length?formatMs(Math.round(avg)):'00:00.00';
  $('#kpiBrct').textContent=br!==null?formatMs(Math.round(br)):'‚Äì';
}

/* ===== Diagram ===== */
function drawChart(){
  const dpr=window.devicePixelRatio||1;
  const c=document.getElementById('chart');
  const clientW=Math.max(1,c.clientWidth), clientH=Math.max(1,c.clientHeight);
  const W=clientW*dpr, H=clientH*dpr;
  c.width=W; c.height=H;

  const isMobile = window.innerWidth <= 640;
  const padL = (isMobile ? 40 : 64) * dpr;
  const padR = 96*dpr, padT = 16*dpr, padB = 42*dpr;
  const innerW=W-padL-padR, innerH=H-padT-padB;
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,W,H);
  if(innerW<=0 || innerH<=0) return;

  const values = laps.map(l=>l.ms);
  if(running){
    const current = Math.max(0, performance.now()-tStart);
    values.push(current);
  }

  const maxMsTmp = values.length ? Math.max(...values,10000) : 10000;
  const maxS = Math.max(10, Math.ceil(maxMsTmp/1000/10)*10);
  const msToY = ms => padT+innerH-(ms/(maxS*1000))*innerH;

  ctx.font = `${12*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
  ctx.textBaseline = 'middle';
  for (let s = 0; s <= maxS; s++) {
    const y = msToY(s * 1000);
    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 1 * dpr;
    ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
    if (s % 5 === 0) {
      ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5 * dpr;
      ctx.beginPath(); ctx.moveTo(padL, y); ctx.lineTo(W - padR, y); ctx.stroke();
      const m = Math.floor(s / 60), sec = s % 60;
      ctx.fillStyle = '#334155';
      ctx.fillText(`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`, 4*dpr, y);
    }
  }

  const n=values.length;
  if(n){
    const gap=Math.max(3*dpr, innerW/(n*20));
    const bw=Math.max(8*dpr,(innerW-gap*(n-1))/n);
    const palette=['#bfdbfe','#93c5fd','#60a5fa','#3b82f6','#2563eb'];

    for(let i=0;i<n;i++){
      const ms=values[i];
      const x=padL+i*(bw+gap);
      const y=msToY(ms);
      const h=msToY(0)-y;
      ctx.fillStyle=palette[i%palette.length];
      ctx.fillRect(Math.round(x),Math.round(y),Math.floor(bw),Math.max(0,Math.round(h)));
      ctx.fillStyle='#1f2937'; ctx.font=`${10*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
      ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.fillText(`${i+1}`,x+bw/2,H-padB+6*dpr);
    }
  }

  const arr=laps.map(l=>l.ms);
  const guides=[];
  if(arr.length){
    const avg=avgMs(arr);
    guides.push({ y: msToY(avg), color:'#f97316', text:`${L[lang].KPI_AVG_SHORT} ${formatMs(Math.round(avg))}`, dash:[6*dpr,4*dpr] });
    const br=brctMs(arr);
    if(br!==null){
      guides.push({ y: msToY(br), color:'#16a34a', text:`${L[lang].KPI_BRCT_SHORT} ${formatMs(Math.round(br))}`, dash:[4*dpr,3*dpr] });
    }
  }
  const taktVal = Number(taktInput.value || 0);
  if(taktVal>0){
    guides.push({ y: msToY(taktVal*1000), color:'#dc2626', text:`${L[lang].TAKT_LABEL} ${taktVal}s`, dash:[2*dpr,3*dpr] });
  }

  guides.sort((a,b)=>a.y-b.y);
  const minSep = 16*dpr;
  for(let i=1;i<guides.length;i++){
    if(guides[i].y - guides[i-1].y < minSep){
      guides[i].y = guides[i-1].y + minSep;
    }
  }
  guides.forEach(g=>{
    g.y = Math.max(12*dpr, Math.min(padT + (H-padB-padT), g.y));
  });

  guides.forEach(g=>{
    ctx.setLineDash(g.dash||[]);
    ctx.strokeStyle=g.color; ctx.lineWidth=1.7*dpr;
    ctx.beginPath(); ctx.moveTo(padL, g.y); ctx.lineTo(W - padR, g.y); ctx.stroke();
    ctx.setLineDash([]);

    ctx.beginPath(); ctx.moveTo(W - padR, g.y); ctx.lineTo(W - padR + 6*dpr, g.y); ctx.stroke();

    const labelPadX=6*dpr, labelPadY=3*dpr;
    ctx.font = `${12*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
    const textW = ctx.measureText(g.text).width;
    const boxW = textW + labelPadX*2 + 4*dpr;
    const boxH = 18*dpr;

    const bx = W - padR + 8*dpr;
    const by = g.y - boxH/2;

    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.strokeStyle = '#cbd5e1';
    ctx.lineWidth = 1*dpr;
    roundRect(ctx, bx, by, boxW, boxH, 4*dpr, true, true);
    ctx.fillStyle = g.color;
    ctx.fillRect(bx, by, 3*dpr, boxH);

    ctx.fillStyle = '#0f172a';
    ctx.textBaseline='middle'; ctx.textAlign='left';
    ctx.fillText(g.text, bx + labelPadX + 3*dpr, g.y);
  });
}

function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  if (typeof r === 'number') r = {tl:r,tr:r,br:r,bl:r};
  ctx.beginPath();
  ctx.moveTo(x + r.tl, y);
  ctx.lineTo(x + w - r.tr, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r.tr);
  ctx.lineTo(x + w, y + h - r.br);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r.br, y + h);
  ctx.lineTo(x + r.bl, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r.bl);
  ctx.lineTo(x, y + r.tl);
  ctx.quadraticCurveTo(x, y, x + r.tl, y);
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}

function loop(){
  drawChart();
  if(running) rafId = requestAnimationFrame(loop);
  else rafId = null;
}
function startLoop(){
  if(rafId==null) rafId = requestAnimationFrame(loop);
}
function stopLoop(){
  if(rafId!=null){ cancelAnimationFrame(rafId); rafId=null; }
}

/* ===== Persistens ===== */
function saveState(){
  try{
    const payload={
      lang,
      laps:laps.map(l=>({ms:l.ms,note:l.note||''})),
      process:processInput.value||'',
      date:dateInput.value||'',
      takt:Number(taktInput.value)||0
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(err){ console.warn('Failed to save state', err); }
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const stored=JSON.parse(raw);
    if(stored && typeof stored==='object'){
      if(stored.lang && L[stored.lang]) lang=stored.lang;
      if(Array.isArray(stored.laps)){
        laps=stored.laps.map(item=>({ms:Number(item.ms)||0,note:item.note||''})).filter(item=>item.ms>0);
      }
      if(typeof stored.process==='string') processInput.value=stored.process;
      if(typeof stored.date==='string') dateInput.value=stored.date;
      if(typeof stored.takt==='number') taktInput.value = stored.takt || '';
    }
  }catch(err){ console.warn('Failed to load state', err); }
}

/* ===== Spr√•kknapp ===== */
function toggleLanguage(){
  lang = (lang==='sv') ? 'en' : 'sv';
  setLangTexts();
  refreshUI();
}

/* ===== DELNING / NEDLADDNING ===== */
function buildCSVBlob() {
  const rows=[];
  rows.push(['Process', processInput.value||'']);
  rows.push(['Date', dateInput.value||'']);
  rows.push(['Takt (s)', Number(taktInput.value)||0]);
  rows.push([]);
  rows.push(['Cycle','ms','sec','Notes']);
  laps.forEach((lap,i)=>{
    rows.push([`${i+1}`, lap.ms, formatSecondsForCSV(lap.ms), (lap.note||'').replace(/\n/g,' ')]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  return new Blob([csv],{type:'text/csv;charset=utf-8;'});
}
function downloadBlob(blob, filename){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
async function shareOrDownloadFile(blob, filename, mime, preferShare=true){
  try{
    const file = new File([blob], filename, { type: mime });
    if (preferShare && navigator.canShare && navigator.canShare({ files:[file] })) {
      await navigator.share({
        files: [file],
        title: filename,
        text: (lang==='sv' ? 'Se bifogad fil.' : 'See attached file.')
      });
      return;
    }
  }catch(e){}
  downloadBlob(blob, filename);
}

/* ===== Export CSV ===== */
async function exportCSV(){
  const stamp = new Date().toISOString().slice(0,10);
  const blob = buildCSVBlob();
  const filename = `20-cycle-check-${stamp}.csv`;
  const ask = (lang==='sv')
    ? 'Vill du skicka via e-post/DELNING (OK) eller bara ladda ner (Avbryt)?'
    : 'Send via email/SHARE (OK) or just download (Cancel)?';
  const preferShare = window.confirm(ask);
  await shareOrDownloadFile(blob, filename, 'text/csv', preferShare);
}

/* ===== Export PDF-rapport (A4 liggande) ===== */
async function exportReport(){
  drawChart();

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('l', 'mm', 'a4');

  const pageW = pdf.internal.pageSize.getWidth();
  const pageH = pdf.internal.pageSize.getHeight();
  const M = 12;
  let x = M, y = M;

  pdf.setFillColor(245,247,250);
  pdf.roundedRect(M-2, M-6, pageW-2*M+4, 16, 3, 3, 'F');
  pdf.setFont('helvetica','bold'); pdf.setFontSize(16);
  pdf.text('20 Cycle Check', x, y+5);
  pdf.setFont('helvetica','normal'); pdf.setFontSize(11);
  pdf.text((lang==='sv'?'Process: ':'Process: ') + (processInput.value||'‚Äî'), x+70, y+5);
  pdf.text((lang==='sv'?'Datum: ':'Date: ') + (dateInput.value||'‚Äî'), x+140, y+5);
  y += 20;

  const canvas = document.getElementById('chart');
  const imgData = canvas.toDataURL('image/png', 1.0);
  const chartW = pageW * 0.60 - M;
  const chartH = pageH - y - M;
  pdf.roundedRect(x-2, y-2, chartW+4, chartH+4, 3, 3);
  pdf.addImage(imgData, 'PNG', x, y, chartW, chartH, undefined, 'FAST');

  const rightX = x + chartW + 10;
  let ry = y;

  const arr = laps.map(l=>l.ms);
  const avg = (arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0);
  const br = (arr.length>=5? [...arr].sort((x,y)=>x-y).slice(0,5).reduce((a,b)=>a+b,0)/5 : null);
  const longest = arr.length? Math.max(...arr):0;
  const shortest = arr.length? Math.min(...arr):0;
  const dPct = (avg>0 && br!==null) ? ((avg - br)/avg*100) : 0;
  const taktVal = Number(taktInput.value || 0);

  function kpi(label, value){
    pdf.setDrawColor(229,231,235);
    pdf.setFillColor(255,255,255);
    pdf.roundedRect(rightX, ry, pageW-rightX-M, 12, 2, 2, 'FD');
    pdf.setFontSize(10); pdf.setTextColor(107,114,128);
    pdf.text(label, rightX+3, ry+4.5);
    pdf.setFontSize(12); pdf.setTextColor(15,23,42);
    pdf.text(value, rightX+3, ry+9);
    ry += 14;
  }
  const lab = L[lang];
  function fmt(ms){return ms?`${String(Math.floor(ms/60000)).padStart(2,'0')}:${String(Math.floor((ms%60000)/1000)).padStart(2,'0')}.${String(Math.floor((ms%1000)/10)).padStart(2,'0')}`:'00:00.00'}
  kpi(lab.KPI_AVG, arr.length?fmt(avg):'00:00.00');
  kpi(lab.KPI_BRCT, br!==null?fmt(br):'‚Äì');
  kpi(lab.LONGEST, arr.length?fmt(longest):'‚Äì');
  kpi(lab.SHORTEST, arr.length?fmt(shortest):'‚Äì');
  kpi(lab.TAKT_LABEL, taktVal>0? (taktVal+'s') : '‚Äì');
  kpi(lab.DISTURBANCE, dPct.toFixed(1)+'%');

  ry += 4;

  pdf.setFont('helvetica','bold'); pdf.setFontSize(12);
  pdf.text(lang==='sv'?'Cykler':'Cycles', rightX, ry); ry += 6;
  pdf.setFont('helvetica','normal'); pdf.setFontSize(10);

  const colW1 = 16, colW2 = 26, colW3 = (pageW-rightX-M) - colW1 - colW2 - 4;
  const rowH = 6;
  function row(x1,y1,vals,bold=false){
    pdf.setFont('helvetica', bold?'bold':'normal'); pdf.setFontSize(10);
    pdf.text(String(vals[0]), x1+2, y1+4);
    pdf.text(String(vals[1]), x1+2+colW1, y1+4);
    const note = String(vals[2]||'');
    pdf.text(note.substring(0,40), x1+2+colW1+colW2, y1+4);
    pdf.setDrawColor(229,231,235);
    pdf.line(x1, y1+rowH, x1+colW1+colW2+colW3, y1+rowH);
  }
  pdf.setDrawColor(229,231,235);
  pdf.line(rightX, ry, rightX+colW1+colW2+colW3, ry);
  row(rightX, ry, [lang==='sv'?'Nr':'No', lang==='sv'?'Tid':'Time', lang==='sv'?'Anteckning':'Notes'], true);
  ry += rowH;

  const maxRows = Math.floor((pageH - ry - M)/rowH);
  const timesToShow = Math.min(maxRows, laps.length);
  for(let i=0;i<timesToShow;i++){
    const l = laps[i];
    row(rightX, ry, [i+1, fmt(l.ms), (l.note||'')], false);
    ry += rowH;
  }

  pdf.setFontSize(9); pdf.setTextColor(107,114,128);
  const stamp = new Date().toISOString().slice(0,19).replace('T',' ');
  pdf.text((lang==='sv'?'Genererad: ':'Generated: ') + stamp, M, pageH - 6);
  pdf.text('¬© 20 Cycle Check', pageW - M - 28, pageH - 6);

  const filename = `20-cycle-check-report-${new Date().toISOString().slice(0,10)}.pdf`;
  const pdfBlob = pdf.output('blob');
  const preferShare = window.confirm(lang==='sv'
    ? 'Vill du skicka rapporten via e-post/DELNING (OK) eller ladda ner (Avbryt)?'
    : 'Share report via email/SHARE (OK) or download (Cancel)?'
  );
  await shareOrDownloadFile(pdfBlob, filename, 'application/pdf', preferShare);
}

/* ===== Reset ===== */
function resetApp(){
  if(!confirm(lang==='sv'?'√Ñr du s√§ker p√• att du vill nollst√§lla?':'Are you sure you want to reset?')) return;
  if(running){ stopTimer(); }
  laps=[]; selectedIndex=-1; processInput.value=''; dateInput.value=''; taktInput.value='';
  refreshUI();
}

/* ===== NEW: Kundtakt-utr√§kning (45 veckor/√•r) ===== */
function calcCustomerTaktInteractive(){                 /* NEW */
  const volStr = window.prompt(L[lang].PROMPT_VOLUME, '');   /* NEW */
  if(volStr===null) return;                                  /* NEW */
  const hrsStr = window.prompt(L[lang].PROMPT_HOURS, '78');  /* NEW */
  if(hrsStr===null) return;                                  /* NEW */

  const annualVol = Number(volStr);                          /* NEW */
  const hoursPerWeek = Number(hrsStr);                       /* NEW */
  if(!isFinite(annualVol) || annualVol<=0 ||                 /* NEW */
     !isFinite(hoursPerWeek) || hoursPerWeek<=0){            /* NEW */
    window.alert(L[lang].ALERT_BAD_INPUT);                   /* NEW */
    return;                                                  /* NEW */
  }                                                          /* NEW */

  const secondsPerYear = hoursPerWeek * 45 * 3600;           /* NEW: 45 veckor/√•r */
  const taktSeconds = secondsPerYear / annualVol;            /* NEW */
  taktInput.value = String(Math.round(taktSeconds));         /* NEW: heltal sek */
  saveState();                                               /* NEW */
  drawChart();                                               /* NEW */
}                                                            /* NEW */

/* ===== Refresh UI ===== */
function refreshUI(){
  renderList();
  updateKPIs();
  drawChart();
  saveState();
}

/* ===== Init ===== */
function init(){
  loadState();
  setLangTexts();
  refreshUI();
  stopBtn.disabled=true;
  timerDisp.textContent='00:00.00';

  document.getElementById('btnLang').addEventListener('click', toggleLanguage);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnReport').addEventListener('click', exportReport);
  document.getElementById('btnReset').addEventListener('click', resetApp);
  processInput.addEventListener('input', saveState);
  dateInput.addEventListener('input', saveState);
  taktInput.addEventListener('input', ()=>{ saveState(); drawChart(); });
  window.addEventListener('resize', ()=>{ drawChart(); });

  document.getElementById('btnCalcTakt').addEventListener('click', calcCustomerTaktInteractive); /* NEW */

  drawChart();
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
