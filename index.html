<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>20 Cycle Check ‚Äî Process Observation</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="format-detection" content="telephone=no">
<meta name="theme-color" content="#ffffff">
<style>
  :root{
    --bg:#f7f7f9; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e5e7eb; --accent:#2563eb;
    --radius:10px; --tap:40px; --fs:clamp(13px,2.2vw,15px); --fs-sm:clamp(11px,1.9vw,13px);
    --blue-600:#2563eb; --blue-500:#3b82f6; --blue-400:#60a5fa; --blue-300:#93c5fd;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;font-size:var(--fs);background:var(--bg);color:var(--ink)}
  .app{min-height:100%;padding:8px}

  /* Menyrad ‚Äì allt f√•r plats √§ven i mobil */
  .menubar{
    display:flex;flex-wrap:wrap;align-items:center;gap:8px;
    background:var(--paper);border:1px solid var(--line);border-radius:var(--radius);
    padding:6px 10px;margin-bottom:8px
  }
  .logo{font-weight:800;font-size:16px;white-space:nowrap;margin-right:auto}
  .menu-actions{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  .langbtn{
    display:inline-flex;align-items:center;gap:8px;
    padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm);cursor:pointer
  }
  .flag{font-size:16px;line-height:1}

  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;min-height:var(--tap);padding:8px 12px;border-radius:8px;border:1px solid var(--line);background:#fff;color:inherit;cursor:pointer}
  .btn.primary{background:var(--blue-600);color:#fff;border-color:#1d4ed8}
  .btn.secondary{background:#fff;border-color:var(--line)}
  .btn.danger{background:#fee2e2;border-color:#fecaca}
  .btn.small{min-height:34px;padding:6px 10px;font-size:var(--fs-sm)}

  /* Korten h√∂gst upp: Spr√•k + Process/Date, samt Start/Timer/Stop */
  .top-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .card{background:var(--paper);border:1px solid var(--line);border-radius:var(--radius)}
  .pad{padding:8px}
  label{font-size:var(--fs-sm);color:var(--muted)}
  input[type=text]{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff}

  .lang-card .row1{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  .lang-card .row2{display:grid;grid-template-columns:1fr 160px;gap:8px;margin-top:8px}
  .timer-card .controls{display:flex;gap:8px;align-items:center}
  .timer-card .start{flex:0 0 35%}
  .timer-card .mid{flex:0 0 50%;display:flex;justify-content:center}
  .timer-card .stop{flex:0 0 15%}
  .timer{font-weight:800;font-size:18px;background:#0a0;color:#fff;padding:10px 12px;border-radius:8px;text-align:center;min-width:120px}

  /* Resultat + diagram */
  .wrap{display:grid;grid-template-columns:1.2fr 0.8fr;gap:8px;margin-top:8px}
  .chart-card{display:flex;flex-direction:column}
  .chart-header{display:flex;flex-direction:column;gap:8px;border-bottom:1px solid var(--line);padding-bottom:10px}
  .chart-title{margin:0;font-size:18px;font-weight:700;color:var(--ink)}
  .kpis{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:var(--fs-sm)}
  .chart-wrap{padding:6px}
  canvas{width:100%;height:360px;display:block}

  /* Lista */
  .list-head,.list-row{display:grid;grid-template-columns:56px 110px 1fr 40px;gap:8px;align-items:center}
  .list-head{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);padding:8px;font-weight:700;z-index:1}
  .list{max-height:460px;overflow:auto;border-top:1px solid var(--line);padding:8px}
  .list-row{
    padding:10px;background:#fff;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;box-shadow:0 1px 2px rgba(0,0,0,.04);
  }
  .list-row:nth-child(odd){background:#f9fbff}
  .list-row.selected{outline:2px solid #93c5fd;background:#eff6ff}
  .badge{display:inline-block;background:#e2e8f0;color:#334155;padding:4px 8px;border-radius:999px;font-size:var(--fs-sm);font-weight:600}
  textarea{width:100%;min-height:40px;border:1px solid var(--line);border-radius:8px;padding:6px;font:inherit;font-size:var(--fs-sm)}
  .delete-btn{cursor:pointer;border:none;background:none;font-size:18px;line-height:1;color:#dc2626}
  .delete-btn:hover{color:#b91c1c}

  @media (max-width:980px){
    .wrap{grid-template-columns:1fr}
    canvas{height:300px}
    .top-grid{grid-template-columns:1fr}
  }
  @media (max-width:640px){
    .kpis{grid-template-columns:1fr}
    .list-head{display:none}
    .list{max-height:none;padding:8px}
    .list-row{grid-template-columns:repeat(2,minmax(0,1fr));grid-template-areas:
      "cycle time"
      "problems problems"
      "delete delete"}
    .list-row .cycle{grid-area:cycle}
    .list-row .time{grid-area:time}
    .list-row .problems{grid-area:problems}
    .list-row .delete-cell{grid-area:delete;text-align:right}
    .timer-card .controls{gap:6px}
  }
</style>
</head>
<body>
<div class="app">

  <!-- Menyrad -->
  <div class="menubar">
    <div class="logo">20 Cycle Check</div>
    <div class="menu-actions">
      <button id="btnLang" class="langbtn"><span class="flag">üá∏üá™</span><span id="langLabel">SV</span></button>
      <button id="btnExport" class="btn small">Exportera</button>
      <button id="btnReset" class="btn small danger">Nollst√§ll</button>
    </div>
  </div>

  <!-- Spr√•k + Process/Datum  |  Start/Timer/Stop -->
  <div class="top-grid">
    <div class="card pad lang-card">
      <div class="row1">
        <!-- samma spr√•kknapp visas √§ven h√§r om du vill; vi beh√•ller endast i menyraden f√∂r plats -->
        <label id="lblInfo" style="color:var(--muted);font-size:var(--fs-sm)"></label>
      </div>
      <div class="row2">
        <div>
          <label id="lblProcess">PROCESS</label>
          <input id="process" type="text" placeholder="Ange processnamn‚Ä¶">
        </div>
        <div>
          <label id="lblDate">DATE</label>
          <input id="date" type="text" placeholder="yyyy-mm-dd">
        </div>
      </div>
    </div>

    <div class="card pad timer-card">
      <div class="controls">
        <div class="start"><button id="btnToggle" class="btn primary" style="width:100%;font-size:16px;padding:12px 14px">Start</button></div>
        <div class="mid"><div class="timer" id="timerDisp">00:00.00</div></div>
        <div class="stop"><button id="btnStop" class="btn secondary" style="width:100%">Stoppa</button></div>
      </div>
    </div>
  </div>

  <!-- Diagram + KPI + Lista -->
  <div class="wrap">
    <div class="card chart-card">
      <div class="chart-header pad">
        <h3 id="resultsTitle" class="chart-title">Resultat</h3>
        <div class="kpis">
          <div class="pill"><span id="kpiAvgLabel"></span> <b id="kpiAvg">00:00.00</b></div>
          <div class="pill"><span id="kpiBrctLabel"></span> <b id="kpiBrct">‚Äì</b></div>
        </div>
      </div>
      <div class="chart-wrap">
        <canvas id="chart" height="360"></canvas>
      </div>
    </div>

    <div class="card pad">
      <div class="list-head">
        <div id="thCycle">CYCLE</div>
        <div id="thTime">TIME(S)</div>
        <div id="thProblems">OBSERVED PROBLEMS</div>
        <div> </div>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>
</div>

<script>
/* ===== i18n ===== */
const L={
  sv:{INFO:"Spr√•k: Svenska (tryck f√∂r att v√§xla)",PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Ange processnamn‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TOGGLE_START:"Start",TOGGLE_LAP:"Varv",STOP:"Stoppa",RESET:"Nollst√§ll",EXPORT:"Exportera",
      RESULTS_TITLE:"Resultat",AXIS_LABEL:"Tid (mm:ss)",
      KPI_AVG:"√ò CT (medel):",KPI_BRCT:"BRCT (5 snabbaste):",
      KPI_AVG_SHORT:"√ò CT:",KPI_BRCT_SHORT:"BRCT:",CSV_DECIMAL:","},
  en:{INFO:"Language: English (tap to toggle)",PROCESS:"PROCESS",DATE:"DATE",PH_PROCESS:"Enter process name‚Ä¶",PH_DATE:"yyyy-mm-dd",
      TOGGLE_START:"Start",TOGGLE_LAP:"Lap",STOP:"Stop",RESET:"Reset",EXPORT:"Export",
      RESULTS_TITLE:"Results",AXIS_LABEL:"Time (mm:ss)",
      KPI_AVG:"√ò CT (mean):",KPI_BRCT:"BRCT (5 fastest):",
      KPI_AVG_SHORT:"√ò CT:",KPI_BRCT_SHORT:"BRCT:",CSV_DECIMAL:"."}
};
let lang='sv';
const $=s=>document.querySelector(s);

/* ===== Helpers ===== */
function pad(n,w=2){return String(n).padStart(w,'0')}
function formatMs(ms){const cs=Math.round(ms/10),m=Math.floor(cs/6000),s=Math.floor((cs%6000)/100),c=cs%100; return `${pad(m)}:${pad(s)}.${pad(c)}`}
function formatSecondsForCSV(ms){const secs=(ms/1000).toFixed(2); return lang==='en'?secs:secs.replace('.',L[lang].CSV_DECIMAL)}

/* ===== State ===== */
let laps=[]; // {ms,note}
let running=false, tStart=0, tick=null;
let selectedIndex=-1;
const STORAGE_KEY='cycle-check-state-v2';

/* ===== UI refs ===== */
const processInput=$('#process'), dateInput=$('#date');
const toggleBtn=$('#btnToggle'), stopBtn=$('#btnStop'), timerDisp=$('#timerDisp');
const chart=$('#chart'), ctx=chart.getContext('2d',{willReadFrequently:true});

/* ===== i18n apply ===== */
function setLangTexts(){
  $('#lblInfo').textContent=L[lang].INFO;
  $('#lblProcess').textContent=L[lang].PROCESS;
  $('#lblDate').textContent=L[lang].DATE;
  $('#process').placeholder=L[lang].PH_PROCESS;
  $('#date').placeholder=L[lang].PH_DATE;
  $('#btnExport').textContent=L[lang].EXPORT;
  $('#btnReset').textContent=L[lang].RESET;
  $('#resultsTitle').textContent=L[lang].RESULTS_TITLE;
  $('#kpiAvgLabel').textContent=L[lang].KPI_AVG;
  $('#kpiBrctLabel').textContent=L[lang].KPI_BRCT;
  toggleBtn.textContent = running ? L[lang].TOGGLE_LAP : L[lang].TOGGLE_START;
  stopBtn.textContent = L[lang].STOP;
  // topp-knapp etikett + flagga
  $('#langLabel').textContent = lang==='sv'?'SV':'EN';
  $('#btnLang').querySelector('.flag').textContent = lang==='sv'?'üá∏üá™':'üá¨üáß';
  renderList();
}

/* ===== Timer ===== */
function startTimer(){
  if(running) return;
  running=true;
  tStart=performance.now();
  timerDisp.textContent='00:00.00';
  tick=setInterval(()=>{ timerDisp.textContent = formatMs(performance.now()-tStart); }, 50);
  toggleBtn.textContent=L[lang].TOGGLE_LAP;
  stopBtn.disabled=false;
}
function addLap(ms,note=''){
  laps.push({ms,note});
  refreshUI();
}
function lap(){
  if(!running) return;
  const elapsed=Math.max(10, performance.now()-tStart);
  addLap(elapsed);
  tStart=performance.now();
  timerDisp.textContent='00:00.00';
}
function stopTimer(){
  if(running){
    clearInterval(tick); tick=null; running=false;
    stopBtn.disabled=true;
    toggleBtn.textContent=L[lang].TOGGLE_START;
  }
  timerDisp.textContent='00:00.00';
}
function toggle(){ running ? lap() : startTimer(); }
toggleBtn.addEventListener('click', toggle);
stopBtn.addEventListener('click', stopTimer);

/* ===== Tangentbord ===== */
window.addEventListener('keydown', e=>{
  const ae=document.activeElement;
  const tag=ae && ae.tagName ? ae.tagName.toUpperCase(): '';
  if(e.code==='Space'){
    if(e.repeat){ e.preventDefault(); return; }
    if(tag==='TEXTAREA' || (tag==='INPUT' && (ae.type||'').toLowerCase()!=='button')) return;
    e.preventDefault();
    running ? lap() : startTimer();
  }
  if(e.key && e.key.toLowerCase()==='s'){
    if(tag!=='TEXTAREA' && tag!=='INPUT'){ e.preventDefault(); stopTimer(); }
  }
  if(e.key==='Delete' || e.key==='Backspace'){
    if(tag==='TEXTAREA' || tag==='INPUT'){ return; }
    e.preventDefault();
    deleteSelected();
  }
});

/* ===== Markera & radera rader ===== */
function selectRow(ix){
  selectedIndex=ix;
  document.querySelectorAll('.list-row').forEach((r,i)=> r.classList.toggle('selected', i===ix));
}
function deleteSelected(){
  if(selectedIndex<0 || selectedIndex>=laps.length) return;
  laps.splice(selectedIndex,1);
  selectedIndex=-1;
  refreshUI();
}

/* ===== Lista/KPI/Diagram ===== */
function renderList(){
  const list=$('#list'); list.innerHTML='';
  laps.forEach((l,i)=>{
    const row=document.createElement('div'); row.className='list-row';
    if(i===selectedIndex) row.classList.add('selected');
    row.innerHTML=
      `<div class="cell cycle"><span class="badge">#${i+1}</span></div>
       <div class="cell time"><b>${formatMs(l.ms)}</b></div>
       <div class="cell problems">
         <textarea data-ix="${i}" placeholder="Notes / Problem"></textarea>
       </div>
       <div class="delete-cell"><button class="delete-btn" title="Delete" data-ix="${i}">üóëÔ∏è</button></div>`;
    list.appendChild(row);
    const ta=row.querySelector('textarea'); ta.value=l.note||'';
    row.addEventListener('click', ()=> selectRow(i));
    ta.addEventListener('focus', ()=> selectRow(i));
    ta.addEventListener('input', e=>{ const ix=+e.target.dataset.ix; laps[ix].note=e.target.value; saveState(); });
  });
  list.querySelectorAll('.delete-btn').forEach(btn=>btn.addEventListener('click',e=>{
    e.stopPropagation();
    const ix=+e.currentTarget.dataset.ix;
    laps.splice(ix,1);
    if(selectedIndex===ix) selectedIndex=-1; else if(selectedIndex>ix) selectedIndex--;
    refreshUI();
  }));
}

function avgMs(a){return a.length? a.reduce((x,y)=>x+y,0)/a.length:0}
function brctMs(a){ if(a.length<5) return null; return avgMs([...a].sort((x,y)=>x-y).slice(0,5)); }
function updateKPIs(){
  const arr=laps.map(x=>x.ms), avg=avgMs(arr), br=brctMs(arr);
  $('#kpiAvg').textContent=arr.length?formatMs(Math.round(avg)):'00:00.00';
  $('#kpiBrct').textContent=br!==null?formatMs(Math.round(br)):'‚Äì';
}

/* ===== Diagram med v√§nster tidsaxel och linjeetiketter ===== */
function drawChart(){
  const dpr=window.devicePixelRatio||1;
  const c=document.getElementById('chart');
  const clientW=Math.max(1,c.clientWidth), clientH=Math.max(1,c.clientHeight);
  const W=clientW*dpr, H=clientH*dpr;
  c.width=W; c.height=H;
  const padL=64*dpr, padR=18*dpr, padT=16*dpr, padB=42*dpr, innerW=W-padL-padR, innerH=H-padT-padB;
  const ctx=c.getContext('2d');
  ctx.clearRect(0,0,W,H);
  if(innerW<=0 || innerH<=0) return;

  const maxMs=laps.length?Math.max(...laps.map(l=>l.ms),10000):10000;
  const maxS=Math.max(10,Math.ceil(maxMs/1000/10)*10);
  const msToY = ms => padT+innerH-(ms/(maxS*1000))*innerH;

  // ram
  ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=1*dpr; ctx.strokeRect(padL,padT,innerW,innerH);

  // v√§nster tidsaxel + grid
  ctx.fillStyle='#475569'; ctx.font=`${11*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
  ctx.textBaseline='middle';
  for(let s=0;s<=maxS;s+=30){
    const y=msToY(s*1000);
    ctx.strokeStyle=s===0?'#cbd5e1':'#e5e7eb';
    ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(W-padR,y); ctx.stroke();
    const m=Math.floor(s/60), sec=s%60;
    ctx.fillText(`${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`,8*dpr,y);
  }
  // Y-axelrubrik
  ctx.save();
  ctx.fillStyle='#0f172a';
  ctx.font=`${12*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
  ctx.textAlign='center';
  ctx.textBaseline='middle';
  ctx.translate(padL/2, padT+innerH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(L[lang].AXIS_LABEL,0,0);
  ctx.restore();

  // staplar
  const n=laps.length;
  if(n){
    const gap=6*dpr, bw=Math.max(10*dpr,(innerW-gap*(n-1))/n);
    const palette=['#bfdbfe','#93c5fd','#60a5fa','#3b82f6','#2563eb'];
    for(let i=0;i<n;i++){
      const l=laps[i];
      const x=padL+i*(bw+gap);
      const y=msToY(l.ms);
      const h=msToY(0)-y;
      ctx.fillStyle=palette[i%palette.length];
      ctx.fillRect(x,y,bw,h);
      ctx.fillStyle='#1f2937'; ctx.font=`${10*dpr}px system-ui,-apple-system,Segoe UI,Inter,Arial`;
      ctx.textAlign='center'; ctx.textBaseline='top';
      ctx.fillText(`#${i+1}`,x+bw/2,H-padB+6*dpr);
    }

    // √ò CT & BRCT linjer + etiketter med v√§rde
    const arr=laps.map(l=>l.ms);
    const avg=avgMs(arr);
    if(arr.length){
      const yAvg=msToY(avg);
      const avgText=`${L[lang].KPI_AVG_SHORT} ${formatMs(Math.round(avg))}`;
      ctx.setLineDash([6*dpr,4*dpr]);
      ctx.strokeStyle='#f97316'; ctx.lineWidth=1.5*dpr;
      ctx.beginPath(); ctx.moveTo(padL,yAvg); ctx.lineTo(W-padR,yAvg); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='#f97316'; ctx.textAlign='right'; ctx.textBaseline='bottom';
      ctx.fillText(avgText,W-4*dpr,yAvg-4*dpr);
    }
    const br=brctMs(arr);
    if(br!==null){
      const yBr=msToY(br);
      const brText=`${L[lang].KPI_BRCT_SHORT} ${formatMs(Math.round(br))}`;
      ctx.setLineDash([4*dpr,3*dpr]);
      ctx.strokeStyle='#16a34a'; ctx.lineWidth=1.5*dpr;
      ctx.beginPath(); ctx.moveTo(padL,yBr); ctx.lineTo(W-padR,yBr); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='#16a34a'; ctx.textAlign='right'; ctx.textBaseline='top';
      ctx.fillText(brText,W-4*dpr,yBr+4*dpr);
    }
  }
}

function refreshUI({save=true}={}){
  renderList();
  drawChart();
  updateKPIs();
  if(save) saveState();
}

/* ===== Persistens ===== */
function saveState(){
  try{
    const payload={
      lang,
      laps:laps.map(l=>({ms:l.ms,note:l.note||''})),
      process:processInput.value||'',
      date:dateInput.value||''
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(err){ console.warn('Failed to save state', err); }
}
function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const stored=JSON.parse(raw);
    if(stored && typeof stored==='object'){
      if(stored.lang && L[stored.lang]) lang=stored.lang;
      if(Array.isArray(stored.laps)){
        laps=stored.laps.map(item=>({ms:Number(item.ms)||0,note:item.note||''})).filter(item=>item.ms>0);
      }
      if(typeof stored.process==='string') processInput.value=stored.process;
      if(typeof stored.date==='string') dateInput.value=stored.date;
    }
  }catch(err){ console.warn('Failed to load state', err); }
}

/* ===== Spr√•kv√§xling (en enda knapp) ===== */
function toggleLanguage(){
  lang = (lang==='sv') ? 'en' : 'sv';
  setLangTexts();
  refreshUI();
}

/* ===== Export & Reset ===== */
function exportCSV(){
  const rows=[];
  rows.push(['Process', processInput.value||'']);
  rows.push(['Date', dateInput.value||'']);
  rows.push([]);
  rows.push(['Cycle','ms','sec','Notes']);
  laps.forEach((lap,i)=>{
    rows.push([`#${i+1}`, lap.ms, formatSecondsForCSV(lap.ms), (lap.note||'').replace(/\n/g,' ')]);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`20-cycle-check-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
function resetApp(){
  if(!confirm(lang==='sv'?'√Ñr du s√§ker p√• att du vill nollst√§lla?':'Are you sure you want to reset?')) return;
  if(running){ stopTimer(); }
  laps=[]; selectedIndex=-1; processInput.value=''; dateInput.value='';
  refreshUI();
}

/* ===== Init ===== */
function init(){
  loadState();
  setLangTexts();
  refreshUI({save:false});
  stopBtn.disabled=true;
  timerDisp.textContent='00:00.00';

  // handlers
  document.getElementById('btnLang').addEventListener('click', toggleLanguage);
  document.getElementById('btnExport').addEventListener('click', exportCSV);
  document.getElementById('btnReset').addEventListener('click', resetApp);
  processInput.addEventListener('input', saveState);
  dateInput.addEventListener('input', saveState);
  window.addEventListener('resize', drawChart);
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
